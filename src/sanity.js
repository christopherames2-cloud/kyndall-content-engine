// Sanity CMS Service
// Creates draft blog posts from analyzed content

import { createClient } from '@sanity/client'

let client = null

export function initSanity(projectId, dataset, token) {
  client = createClient({
    projectId,
    dataset,
    token,
    apiVersion: '2024-01-01',
    useCdn: false
  })
}

export async function checkIfVideoProcessed(videoId) {
  if (!client) throw new Error('Sanity client not initialized')
  
  const query = `*[_type == "blogPost" && videoId == $videoId][0]`
  const result = await client.fetch(query, { videoId })
  return !!result
}

export async function createDraftBlogPost({
  video,
  analysis,
  productLinks
}) {
  if (!client) throw new Error('Sanity client not initialized')
  
  // Build the content with product links inserted
  let content = analysis.blogContent
  
  // Replace product placeholders with actual links
  for (const productLink of productLinks) {
    const placeholder = `[PRODUCT_LINK:${productLink.name}]`
    let linkHtml = ''
    
    if (productLink.shopmyUrl) {
      linkHtml = `**[${productLink.name}](${productLink.shopmyUrl})** (ShopMy)`
    } else if (productLink.amazonUrl) {
      linkHtml = `**[${productLink.name}](${productLink.amazonUrl})** (Amazon)`
    } else {
      linkHtml = `**${productLink.name}**`
    }
    
    content = content.replace(placeholder, linkHtml)
  }
  
  // Create the blog post document
  const doc = {
    _type: 'blogPost',
    title: analysis.blogTitle,
    slug: {
      _type: 'slug',
      current: generateSlug(analysis.blogTitle)
    },
    seoTitle: analysis.seoTitle,
    seoDescription: analysis.seoDescription,
    excerpt: analysis.blogExcerpt,
    category: analysis.category.toLowerCase(),
    platform: video.platform.toLowerCase(),
    videoUrl: video.url,
    videoId: video.id,
    thumbnail: video.thumbnail ? {
      _type: 'image',
      // Note: You'd need to upload the image to Sanity's asset store
      // For now, we'll store the URL reference
      externalUrl: video.thumbnail
    } : undefined,
    views: video.viewCount ? `${formatViews(video.viewCount)} views` : undefined,
    content: [
      {
        _type: 'block',
        _key: 'intro',
        style: 'normal',
        children: [
          {
            _type: 'span',
            text: content
          }
        ]
      }
    ],
    // Store product info for reference
    productLinks: productLinks.map(p => ({
      _type: 'object',
      _key: p.name.replace(/\s+/g, '-').toLowerCase(),
      name: p.name,
      brand: p.brand,
      amazonUrl: p.amazonUrl,
      shopmyUrl: p.shopmyUrl,
      needsShopmy: !p.shopmyUrl && p.amazonUrl
    })),
    suggestedTags: analysis.suggestedTags,
    status: 'draft', // Always create as draft for Kyndall to review
    publishedAt: new Date().toISOString(),
    autoGenerated: true,
    sourceVideo: {
      id: video.id,
      title: video.title,
      platform: video.platform,
      publishedAt: video.publishedAt
    }
  }
  
  const result = await client.create(doc)
  return result
}

export async function getRecentDrafts(limit = 10) {
  if (!client) throw new Error('Sanity client not initialized')
  
  const query = `*[_type == "blogPost" && status == "draft" && autoGenerated == true] | order(publishedAt desc)[0...$limit] {
    _id,
    title,
    category,
    platform,
    publishedAt,
    productLinks
  }`
  
  return client.fetch(query, { limit })
}

function generateSlug(title) {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '')
    .substring(0, 96)
}

function formatViews(count) {
  const num = parseInt(count)
  if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`
  if (num >= 1000) return `${(num / 1000).toFixed(0)}K`
  return num.toString()
}
